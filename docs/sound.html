<html><head><title>AckCord: Sending custom sound (Advanced)</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Katrix" /><meta name="description" content="A Scala Discord library" /><meta name="og:image" content="/img/poster.png" /><meta name="og:title" content="AckCord: Sending custom sound (Advanced)" /><meta name="og:site_name" content="AckCord" /><meta name="og:url" content="http://ackcord.katsstuff.net" /><meta name="og:type" content="website" /><meta name="og:description" content="A Scala Discord library" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="AckCord: Sending custom sound (Advanced)" /><meta name="twitter:image" content="http://ackcord.katsstuff.netimg/poster.png" /><meta name="twitter:description" content="A Scala Discord library" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/default.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>AckCord</span></div></a></li> <li><a href="/getting_started.html" class="">Getting Started</a></li> <li><a href="/docs/cachesnapshot.html" class="">Shared concepts</a> <ul class="sub_section"> <li><a href="/docs/cachesnapshot.html" class="">CacheSnapshot</a></li> <li><a href="/docs/sharedcommands.html" class="">Shared command concepts</a></li></ul></li> <li><a href="/docs/requests.html" class="">Making Requests</a></li> <li><a href="/docs/cache.html" class="">The cache (Advanced)</a></li> <li><a href="/docs/sound.html" class=" active ">Sending custom sound (Advanced)</a></li> <li><a href="/docs/hicommands.html" class="">High level API commands</a></li> <li><a href="/docs/locommands.html" class="">Low level API commands</a></li> <li><a href="/modules.html" class="">The many modules of AckCord</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/Katrix-/AckCord"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/Katrix-/AckCord"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="Katrix-" data-github-repo="AckCord"><div class="content-wrapper"><section><h1 id="sending-custom-sound-advanced">Sending custom sound (Advanced)</h1>
<p>First of, let me issue a warning. This page is for if you want to implement your own sound provider. If all youâ€™re interested in is sending music or similar, take a look at the lavaplayer module. The recommended way to use audio with AckCord at this point is through the lavaplayer module. However, if you want to create a custom implementation, read on.</p>

<h2 id="manual-labor">Manual labor</h2>
<p>If you want to send sound with AckCord, you currently have to set up and wire up most of the actors yourself. AckCord still hides the details of the WebSocket and UDP connection though. AckCord assumes that you are familiar with how sound works in Discord. If you are not familiar with this, read the <a href="https://discordapp.com/developers/docs/topics/voice-connections">Discord docs for voice connections</a></p>

<h2 id="establishing-a-connection">Establishing a connection</h2>
<p>The first thing you need to do is to tell Discord that you want to begin speaking and send audio. You do this by sending a <code class="highlighter-rouge">VoiceStateUpdate</code> message to the client (and as such to the gateway). From there you wait for two events. <code class="highlighter-rouge">APIMessage.VoiceStateUpdate</code> which gives you access to your <code class="highlighter-rouge">VoiceState</code> and as such your <code class="highlighter-rouge">sessionId</code>, and <code class="highlighter-rouge">APIMessage.VoiceServerUpdate</code> which gives you access to the token and endpoint. Once you have those 3, you want to create and login a voice WebSocket connection. To do this, create a <code class="highlighter-rouge">VoiceWsHandler</code> actor, and send it the <code class="highlighter-rouge">Login</code> message. When creating the actor, you have to decide which actor will receive the audio API messages. You can also specify another actor who will be the actor that receives the audio (I would recommend a dedicated actor with a pinned dispatcher(akka.io.pinned-dispatcher) for the actor that receives the audio).</p>

<h2 id="sending-the-data">Sending the data</h2>
<p>Once you have the WS actor set up, you should expect an <code class="highlighter-rouge">AudioAPIMessage.Ready</code> message sent to the actor which you specified should receive all the audio API messages. This message contains the <code class="highlighter-rouge">UDPHandler</code> actor, which is where you want to send your data. I would recommend setting up an actor just for sending the data. Before sending any data, you always have to send a <code class="highlighter-rouge">SetSpeaking(true)</code> message to the WS handler.</p>

<h3 id="the-naive-standard-way">The naive standard way</h3>
<p>To send an audio packet, you use the <code class="highlighter-rouge">SendData</code> message. You probably want to use a pinned dispatcher(akka.io.pinned-dispatcher) if you choose to use this method. Even with a pinned dispatcher, however, you still need to remember that the akka timers, while lightweight, are not the most accurate. There is, however, a better way, although it requires a bit more state keeping and setup.</p>

<h3 id="utilizing-the-buffer-better">Utilizing the buffer better</h3>
<p>The <code class="highlighter-rouge">UDPHandler</code> actor comes packaged with a buffer. If it cannot send a message this instant, it sends the message as soon possible. Taking advantage of this, you can send one big message containing multiple packets every says 200 ms.</p>

<p>First, send a <code class="highlighter-rouge">BeginBurstMode</code> message to the UDP handler. From here in, the UDP handler sends a <code class="highlighter-rouge">DataRequest</code> packet to the sender of the <code class="highlighter-rouge">BeginBurstMode</code> whenever it reaches a certain threshold from the config. When your actor receives a <code class="highlighter-rouge">DataRequest</code> message from the UDP handler, it should send a <code class="highlighter-rouge">SendDataBurst</code> in the close future. Do note that it does not have to be now, and it should not be now all the time.</p>

<p>If just sending a burst whenever requested, this would be easy. However, you also need to keep track of how much audio you have sent in advance, and send more audio, or wait with sending audio until later based on that information. For example, if we send 12 packets of sound totalling 240ms, and then 30 ms after that receive another request for 12 packets of audio, we might want to wait a bit before sending those packets, to be sure we are not too far ahead.</p>

<h3 id="other-things-to-keep-in-mind">Other things to keep in mind</h3>
<p>If you follow the advice above, creating an audio sender should hopefully not be too hard. One other thing you need to remember is that whenever you stop speaking, you need to send five packets of silence, use the code <code class="highlighter-rouge">udpHandler ! SendDataBurst(Seq.fill(5)(silence))</code> to easily do this. If you need a reference to how the different types of data sender might look like, you can look at <a href="https://github.com/Katrix-/AckCord/blob/master/ackCordLavaplayer/src/main/scala/net/katsstuff/ackcord/lavaplayer/AudioSender.scala">AudioSender</a> and <a href="https://github.com/Katrix-/AckCord/blob/master/ackCordLavaplayer/src/main/scala/net/katsstuff/ackcord/lavaplayer/BurstingAudioSender.scala">BurstingAudioSender</a> in the lavaplayer module. If you are looking for a good Discord music library, <a href="https://github.com/sedmelluq/lavaplayer">LavaPlayer</a> is probably your best bet.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/js/main.js"></script></body></html>